---
- name: Fetch K3s token from server
  delegate_to: "{{ groups['k3s_server'][0] }}"
  slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: k3s_token_raw

- name: Install K3s agent
  shell: |
    curl -sfL https://get.k3s.io | \
      K3S_URL=https://{{ groups['k3s_server'][0] }}:6443 \
      K3S_TOKEN={{ k3s_token }} sh -
  args:
    creates: /usr/local/bin/k3s
  vars:
    k3s_token: "{{ k3s_token_raw.content | b64decode | trim }}"

- name: Enable and start k3s-agent service
  systemd:
    name: k3s-agent
    enabled: true
    state: started
